{% extends "layouts/base.html" %}
{% load static %}
{% block title %} {{ title }} {% endblock %}
{% block body_class %} dashboard {% endblock %}

{% block stylesheets %}
<link href="{% static 'css/app.css' %}" rel="stylesheet">
<style>
  .remove-btn { cursor: pointer; color: #d9534f; }
  .add-btn { cursor: pointer; color: #28a745; }
  .answer-row { margin-bottom: 10px; }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <section class="content-header">
    <h1>{{ title }}</h1>
  </section>

  <section class="content">
    <div class="card card-primary">
      <div class="card-body">
        <form id="answer-form" method="post" action="{% url 'add_answers' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="id_question" class="form-label">Savolni tanlang</label>
            {{ form.question }}
          </div>

          {% if formset %}
            {{ formset.management_form }}

            <div id="formset-container">
              {% for form_item in formset.forms %}
                <div class="answer-row border rounded p-2 mb-2" data-form-index="{{ forloop.counter0 }}">
                  <div class="row mb-2">
                    <div class="col-md-5">
                      <label>Javob (UZ)</label>
                      {{ form_item.answer_uz }}
                    </div>
                    <div class="col-md-5">
                      <label>Javob (RU)</label>
                      {{ form_item.answer_ru }}
                    </div>
                    <div class="col-md-1">
                      <label>Ball</label>
                      {{ form_item.score }}
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                      <button type="button" class="btn btn-outline-danger remove-btn">❌</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

            <!-- Template -->
            <template id="empty-form-template">
              <div class="answer-row border rounded p-2 mb-2">
                <div class="row mb-2">
                  <div class="col-md-5">
                    <label>Javob (UZ)</label>
                    <input type="text" name="__prefix__-answer_uz" class="form-control" placeholder="Javob (UZ)">
                  </div>
                  <div class="col-md-5">
                    <label>Javob (RU)</label>
                    <input type="text" name="__prefix__-answer_ru" class="form-control" placeholder="Javob (RU)">
                  </div>
                  <div class="col-md-1">
                    <label>Ball</label>
                    <input type="number" step="any" name="__prefix__-score" class="form-control" placeholder="Ball">
                  </div>
                  <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger remove-btn">❌</button>
                  </div>
                </div>
              </div>
            </template>

            <div class="mt-3">
              <button type="button" id="add-answer" class="btn btn-outline-success add-btn">➕ Javob qo‘shish</button>
            </div>

            <div class="mt-4">
              <button type="submit" class="btn btn-success">Saqlash</button>
              <a href="{% url 'question_list' %}" class="btn btn-secondary">Bekor qilish</a>
            </div>
          {% endif %}
        </form>
      </div>
    </div>
  </section>
</div>

<!-- ✅ Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 text-center">
      <h5 class="mb-3">✅ Javoblar saqlandi!</h5>
      <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Yopish</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('formset-container');
  const addBtn = document.getElementById('add-answer');
  const template = document.getElementById('empty-form-template');
  const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');

  if (!container || !addBtn || !template) return;

  const getFormCount = () => parseInt(totalFormsInput.value, 10) || 0;
  const setFormCount = (n) => totalFormsInput.value = n;

  addBtn.addEventListener('click', () => {
    const formCount = getFormCount();
    const newForm = template.content.cloneNode(true);

    newForm.querySelectorAll('input').forEach(input => {
      input.name = input.name.replace('__prefix__', `form-${formCount}`);
      input.id = `id_form-${formCount}-${input.name.split('-').pop()}`;
    });

    container.appendChild(newForm);
    setFormCount(formCount + 1);
  });

  container.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-btn')) {
      e.target.closest('.answer-row').remove();
      const currentCount = container.querySelectorAll('.answer-row').length;
      setFormCount(currentCount);
    }
  });

  // ✅ AJAX yuborish
  $('#answer-form').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();

    $.ajax({
      url: $(this).attr('action'),
      method: 'POST',
      data: formData,
      success: function(response) {
        if (response.success) {
          const modal = new bootstrap.Modal(document.getElementById('successModal'));
          modal.show();
          setTimeout(() => {
            window.location.href = response.redirect_url;
          }, 1500);
        }
      },
      error: function(xhr) {
        alert("Xatolik yuz berdi. Ma'lumotni tekshiring!");
        console.log(xhr.responseJSON);
      }
    });
  });
});
</script>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/app.js' %}"></script>
{% endblock %}
