<!DOCTYPE html>
<html>
<head>
  <title>Telegram WebApp Location</title>
  <meta charset="UTF-8">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      transition: background-color 0.3s, color 0.3s;
    }
    button {
      font-size: 1.2em;
      padding: 10px 30px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #enterBtn { background-color: #2ecc71; color: white; }
    #exitBtn { background-color: #e74c3c; color: white; }

    #loader {
      margin-top: 30px;
      width: 60px;
      height: 60px;
      border: 6px solid #ccc;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    #loader.success {
      border-top: 6px solid #2ecc71;
    }
    #loader.fail {
      border-top: 6px solid #e74c3c;
    }

    #resultIcon {
      font-size: 48px;
      margin-top: 20px;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <button id="enterBtn">🔓 Kirish</button>
  <button id="exitBtn">🔒 Chiqish</button>

  <div id="loader"></div>
  <div id="resultIcon"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const loader = document.getElementById("loader");
    const resultIcon = document.getElementById("resultIcon");

    const user_id = tg.initDataUnsafe?.user?.id || 123456789; // fallback uchun

    function showLoader(status) {
      loader.style.display = "block";
      loader.className = status === "success" ? "success" : status === "fail" ? "fail" : "";
      resultIcon.style.display = "none";
    }

    function showResult(status) {
      loader.style.display = "none";
      resultIcon.style.display = "block";
      if (status === "success") {
        resultIcon.textContent = "✅";
        resultIcon.style.color = "#2ecc71";
      } else {
        resultIcon.textContent = "❌";
        resultIcon.style.color = "#e74c3c";
      }
    }

    function sendLocation(actionType) {
      if (navigator.geolocation) {
        showLoader(); // start loader (blue by default)

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const payload = {
              user_id: user_id,
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
              type: actionType === "enter" ? "check_in" : "check_out"
            };

            fetch("https://kpi.boastful.uz/web_app/api/check/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === "SUCCESS") {
                showLoader("success");
                setTimeout(() => showResult("success"), 1000);
              } else {
                showLoader("fail");
                setTimeout(() => showResult("fail"), 1000);
              }
            })
            .catch(err => {
              showLoader("fail");
              setTimeout(() => showResult("fail"), 1000);
            });
          },
          (err) => {
            tg.showAlert("Geolokatsiyani olishda xatolik.");
          }
        );
      } else {
        tg.showAlert("Brauzeringiz geolokatsiyani qo‘llab-quvvatlamaydi.");
      }
    }
    document.getElementById("enterBtn").addEventListener("click", () => {
      sendLocation("enter");
    });

    document.getElementById("exitBtn").addEventListener("click", () => {
      sendLocation("exit");
    });
  </script>
</body>
</html>
